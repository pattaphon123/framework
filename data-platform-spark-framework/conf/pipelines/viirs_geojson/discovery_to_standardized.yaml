description: 'Cleanse and standardize VIIRS GeoJSON data.'

source:
  catalog: '${env.biglake.catalog}'
  schema: 'discovery'
  table: 'viirs_geojson'

target:
  catalog: '${env.gcp.project_id}'
  schema: 'standardized'
  table: 'viirs_geojson_bq'
  table_type: 'bigquery'
  load_type: 'partition_overwrite'
  merge_keys:
    - 'hotspot_id'
  partition_columns:
    - 'data_date'
  technical_columns:
    - name: 'data_date'
      bigquery_type: 'DATE'
    - name: 'load_timestamp'
      bigquery_type: 'TIMESTAMP'
  columns:
    - name: 'feature_id'
      source_column: 'feature_id'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'geometry'
      source_column: 'geometry'
      type: 'binary'
      bigquery_type: 'GEOGRAPHY'
      transformations:
        - type: 'to_wkb'
    - name: 'hotspot_id'
      source_column: 'hotspotid'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'acquisition_date'
      source_column: 'acq_date'
      type: 'date'
      bigquery_type: 'DATE'
      transformations:
        - type: 'to_date'
          format: "yyyy-MM-dd'T'HH:mm:ss"
    - name: 'acquisition_time'
      source_column: 'acq_time'
      type: 'string'
      bigquery_type: 'TIME'
      transformations:
        - type: 'trim'
        - type: 'to_time'
          format: "HHmm"
    - name: 'thai_date'
      source_column: 'th_date'
      type: 'date'
      bigquery_type: 'DATE'
      transformations:
        - type: 'to_date'
          format: "yyyy-MM-dd'T'HH:mm:ss"
    - name: 'thai_time'
      source_column: 'th_time'
      type: 'string'
      bigquery_type: 'TIME'
      transformations:
        - type: 'trim'
        - type: 'to_time'
          format: "HHmm"
    - name: 'brightness_ti4'
      source_column: 'bright_ti4'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'brightness_ti5'
      source_column: 'bright_ti5'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'fire_radiative_power'
      source_column: 'frp'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'confidence'
      source_column: 'confidence'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
        - type: 'lower'
    - name: 'instrument'
      source_column: 'instrument'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'satellite'
      source_column: 'satellite'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'file_name'
      source_column: 'file_name'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'scan'
      source_column: 'scan'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'track'
      source_column: 'track'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'version'
      source_column: 'version'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'timestamp'
      source_column: 'timestamp'
      type: 'bigint'
      bigquery_type: 'INT64'
    - name: 'fire_alarm'
      source_column: 'f_alarm'
      type: 'integer'
      bigquery_type: 'INT64'
    - name: 'view_angle'
      source_column: 'v_angle'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'view_direction'
      source_column: 'v_direct'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'view_distance'
      source_column: 'v_dist'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'latitude'
      source_column: 'latitude'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'longitude'
      source_column: 'longitude'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'utm_east'
      source_column: 'utm_e'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'utm_north'
      source_column: 'utm_n'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'utm_zone'
      source_column: 'utm_zone'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'country_en'
      source_column: 'ct_en'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'country_tn'
      source_column: 'ct_tn'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'changwat'
      source_column: 'changwat'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'province_code'
      source_column: 'pv_code'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'province_en'
      source_column: 'pv_en'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'province_idn'
      source_column: 'pv_idn'
      type: 'integer'
      bigquery_type: 'INT64'
    - name: 'province_tn'
      source_column: 'pv_tn'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'province_t'
      source_column: 'province_t'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'amphoe'
      source_column: 'amphoe'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'amphoe_t'
      source_column: 'amphoe_t'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'amphoe_code'
      source_column: 'ap_code'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'amphoe_en'
      source_column: 'ap_en'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'amphoe_idn'
      source_column: 'ap_idn'
      type: 'integer'
      bigquery_type: 'INT64'
    - name: 'amphoe_tn'
      source_column: 'ap_tn'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'tambol'
      source_column: 'tambol'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'tambon_t'
      source_column: 'tambon_t'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'tambon_code'
      source_column: 'tb_code'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'tambon_en'
      source_column: 'tb_en'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'tambon_idn'
      source_column: 'tb_idn'
      type: 'integer'
      bigquery_type: 'INT64'
    - name: 'tambon_tn'
      source_column: 'tb_tn'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'village'
      source_column: 'village'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'moo'
      source_column: 'moo_1'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'name'
      source_column: 'name_1'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'land_use_code'
      source_column: 'lu_code'
      type: 'integer'
      bigquery_type: 'INT64'
    - name: 'land_use_hp'
      source_column: 'lu_hp'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'land_use_hp_name'
      source_column: 'lu_hp_name'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'land_use_name'
      source_column: 'lu_name'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'reference_nesdb'
      source_column: 're_nesdb'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'reference_royin'
      source_column: 're_royin'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'link_gmap'
      source_column: 'linkgmap'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'record_id'
      source_column: '_id'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'created_at'
      source_column: '_createdAt'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'created_by'
      source_column: '_createdBy'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'updated_at'
      source_column: '_updatedAt'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    - name: 'updated_by'
      source_column: '_updatedBy'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
  quality_checks:
    - type: 'not_null'
      column: 'hotspot_id'
      on_fail: 'FAIL'
    - type: 'not_null'
      column: 'feature_id'
      on_fail: 'FAIL'
    - type: 'not_null'
      column: 'geometry'
      on_fail: 'FAIL'
    - type: 'not_null'
      column: 'acquisition_date'
      on_fail: 'WARN'
    - type: 'value_in'
      column: 'confidence'
      values:
        - 'nominal'
        - 'low'
        - 'high'
      on_fail: 'WARN'
    - type: 'value_in'
      column: 'instrument'
      values:
        - 'VIIRS'
        - 'MODIS'
      on_fail: 'WARN'
    - type: 'min'
      column: 'brightness_ti4'
      value: 0
      on_fail: 'WARN'
    - type: 'min'
      column: 'brightness_ti5'
      value: 0
      on_fail: 'WARN'
    - type: 'min'
      column: 'fire_radiative_power'
      value: 0
      on_fail: 'WARN'
    - type: 'value_in_range'
      column: 'latitude'
      min_value: -90
      max_value: 90
      on_fail: 'WARN'
    - type: 'value_in_range'
      column: 'longitude'
      min_value: -180
      max_value: 180
      on_fail: 'WARN'
