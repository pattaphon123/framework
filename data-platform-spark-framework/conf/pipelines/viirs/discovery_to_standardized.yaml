pipeline_name: 'viirs'
description: 'Standardize all VIIRS hotspot data columns.'

source:
  catalog: '${env.biglake.catalog}'
  schema: 'discovery__nasa'
  table: 'viirs'
  type: 'iceberg'

target:
  catalog: '${env.gcp.project_id}'
  schema: 'standardized__nasa'
  table: 'viirs'
  description: 'Full VIIRS hotspot data with geometry and admin details'
  table_type: 'bigquery'
  load_type: 'partition_overwrite'
  merge_keys:
    - 'hotspotid'
  partition_columns:
    - 'data_date'
  technical_columns:
    - name: 'data_date'
      bigquery_type: 'DATE'
    - name: 'load_timestamp'
      bigquery_type: 'TIMESTAMP'

  columns:
  # --- Geometry & IDs ---
    - name: 'hotspotid'
      source_column: 'hotspotid'
      type: 'string'
      bigquery_type: 'STRING'
      transformations:
        - type: 'trim'
    
    - name: 'feature_id'
      source_column: 'feature_id'
      type: 'string'
      bigquery_type: 'STRING'

    - name: 'geometry'
      source_column: 'geometry'
      type: 'binary'
      bigquery_type: 'GEOGRAPHY'
      transformations:
        - type: 'to_wkb'

  # --- System Metadata (Parsed to Timestamp) ---
    - name: '_createdAt'
      source_column: '_createdAt'
      type: 'timestamp'
      bigquery_type: 'TIMESTAMP'
      transformations:
        - type: 'to_timestamp'
          format: "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"
    - name: '_updatedAt'
      source_column: '_updatedAt'
      type: 'timestamp'
      bigquery_type: 'TIMESTAMP'
      transformations:
        - type: 'to_timestamp'
          format: "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"
    - name: '_createdBy'
      type: 'string'
      bigquery_type: 'STRING'
    - name: '_updatedBy'
      type: 'string'
      bigquery_type: 'STRING'
    - name: '_id'
      type: 'string'
      bigquery_type: 'STRING'

  # --- Date & Time ---
    - name: 'acquired_date'
      source_column: 'acq_date'
      type: 'date'
      bigquery_type: 'DATE'
      transformations:
        - type: 'to_date'
          format: "yyyy-MM-dd'T'HH:mm:ss"
    
    - name: 'acquired_time'
      source_column: 'acq_time'
      type: 'string'
      bigquery_type: 'TIME'
      transformations:
        - type: 'to_time'
          format: 'HHmm'

    - name: 'timestamp'
      source_column: 'timestamp'
      type: 'long'
      bigquery_type: 'INT64'
      description: 'Epoch timestamp'

    - name: 'thai_date'
      source_column: 'th_date'
      type: 'date'
      bigquery_type: 'DATE'
      transformations:
        - type: 'to_date'
          format: "yyyy-MM-dd'T'HH:mm:ss"

    - name: 'thai_time'
      source_column: 'th_time'
      type: 'string'
      bigquery_type: 'TIME'
      transformations:
        - type: 'to_time'
          format: 'HHmm'

  # --- Measurements (Numeric) ---
    - name: 'latitude'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'longitude'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'bright_ti4'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'bright_ti5'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'frp'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'scan'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'track'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'confidence'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'instrument'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'satellite'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'version'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'file_name'
      type: 'string'
      bigquery_type: 'STRING'

  # --- Administrative & Location ---
    - name: 'ct_en'
      source_column: 'ct_en'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'ct_tn'
      source_column: 'ct_tn'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'amphoe'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'amphoe_t'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'tambol'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'tambon_t'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'changwat'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'province_t'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'village'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'moo_1'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'name_1'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'linkgmap'
      type: 'string'
      bigquery_type: 'STRING'

  # --- Codes & IDs (Integer or String) ---
    - name: 'ap_idn'
      type: 'long'
      bigquery_type: 'INT64'
    - name: 'pv_idn'
      type: 'long'
      bigquery_type: 'INT64'
    - name: 'tb_idn'
      type: 'long'
      bigquery_type: 'INT64'
    - name: 'ap_code'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'pv_code'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'tb_code'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'ap_en'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'ap_tn'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'pv_en'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'pv_tn'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'tb_en'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'tb_tn'
      type: 'string'
      bigquery_type: 'STRING'

  # --- Land Use & Others ---
    - name: 'lu_code'
      type: 'long'
      bigquery_type: 'INT64'
    - name: 'lu_hp'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'lu_hp_name'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'lu_name'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'f_alarm'
      type: 'long'
      bigquery_type: 'INT64'
    - name: 'utm_e'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'utm_n'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'utm_zone'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'v_angle'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 'v_direct'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 'v_dist'
      type: 'double'
      bigquery_type: 'FLOAT64'
    - name: 're_nesdb'
      type: 'string'
      bigquery_type: 'STRING'
    - name: 're_royin'
      type: 'string'
      bigquery_type: 'STRING'

  quality_checks:
    - type: 'not_null'
      column: 'hotspotid'
      on_fail: 'FAIL'
    - type: 'not_null'
      column: 'geometry'
      on_fail: 'FAIL'